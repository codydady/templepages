<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Templepages - temples , trains , nithyadharma & sriram ! </title>

    <!-- CRITICAL FIX: This script now runs immediately as the browser parses the HTML. -->
    <script>
        const repoName = 'templepages';
        const path = window.location.pathname;
        const baseTag = document.createElement('base');
        const MAX_IMGS_TO_FETCH = 8;
        let basePath;

        if (path.includes(`/${repoName}/`)) {
            basePath = `/${repoName}/`;
            baseTag.href = basePath;
        } else {
            basePath = '/';
            baseTag.href = basePath;
        }
        document.head.prepend(baseTag);

        document.addEventListener('DOMContentLoaded', () => {
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand) {
                navbarBrand.href = basePath;
            }
            const logoImg = document.querySelector('.navbar-logo');
            if (logoImg) {
                logoImg.src = `${basePath}static/logo.png`;
            }
        });
    </script>

    <!-- Bootstrap CSS and Font Awesome for icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">

    <style>
        /* This is the new, combined CSS for a better layout */
        :root, [data-bs-theme="dark"] {
            --theme-bg: #0d0c1d;
            --theme-bg-secondary: #1a1a2e;
            --theme-card-bg: #1a1a2e;
            --theme-text: #f0f0f0;
            --theme-text-muted: #b0b0b0;
            --theme-border: rgba(255, 255, 255, 0.1);
        }
        [data-bs-theme="light"] {
            --theme-bg: #f8f6f0;
            --theme-bg-secondary: #ede8dc;
            --theme-card-bg: #fff;
            --theme-text: #2c3e50;
            --theme-text-muted: #7f8c8d;
            --theme-border: rgba(0, 0, 0, 0.1);
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Lora", "Palatino Linotype", "Book Antiqua", Palatino, serif;
            font-size: 1.0rem;
            line-height: 1.6;
            background-color: var(--theme-bg);
            color: var(--theme-text);
            transition: background-color 0.3s, color 0.3s;
        }

        /*
            CRITICAL FIX: The entire header is now a single container
            that is fixed to the top of the viewport.
        */
        .fixed-header-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1020;
            background-color: transparent;
            padding: 0 1rem;
        }

        /*
            CRITICAL FIX: This is the main content wrapper. The top margin
            ensures the content is pushed down far enough to be fully visible,
            even when the header wraps.
        */
        .main-content-wrapper {
            margin-top: 120px;
            padding: 1rem;
        }

        /* Responsive adjustments for the main content wrapper */
        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-top: 100px; /* Reduced margin for smaller screens */
            }
        }

        .navbar {
            background-color: var(--theme-bg-secondary) !important;
            border-bottom: none;
            z-index: 1020;
            border-radius: 12px;
        }

        .navbar-logo {
            width: 36px;
            height: 36px;
            object-fit: cover;
            border-radius: 20%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .navbar-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .navbar-brand {
            font-size: 1.25rem !important;
            font-weight: 700 !important;
        }

        .header-title {
            font-family: 'Dancing Script', cursive;
            font-weight: 700;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            color: var(--theme-text);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transition: color 0.3s ease;
        }

        .header-title:hover {
            color: #ffcc00;
        }

        .post-header {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--theme-border);
        }
        .post-title {
            font-size: 2.0rem;
            font-weight: 700;
        }
        .post-meta {
            color: var(--theme-text-muted);
            font-size: 0.9rem;
        }
        .tag-link {
            display: inline-block;
            margin-right: 8px;
            margin-top: 8px;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text);
            text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .tag-link:hover {
            background-color: #ffcc00;
            color: #0d0c1d;
        }
        .image-gallery .row > div {
            padding: 5px;
        }
        .image-gallery img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            transition: transform 0.2s ease-in-out;
        }
        .image-gallery img:hover {
            transform: scale(1.03);
            z-index: 10;
        }
        .post-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--theme-text-muted);
        }
        .floating-action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .floating-action-buttons .btn {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }
        .floating-action-buttons .btn:hover {
            transform: translateY(-2px);
        }
        .floating-nav {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 1030;
            background: var(--theme-card-bg);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--theme-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            min-width: 200px;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .floating-nav.show {
            transform: translateX(0);
        }
        .floating-nav .nav-link {
            color: var(--theme-text);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
            text-decoration: none;
            display: block;
        }
        .floating-nav .nav-link:hover {
            background: var(--theme-bg-secondary);
            color: var(--bs-primary);
        }
        .menu-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--theme-text);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1035;
        }
        .menu-toggle:hover {
            transform: scale(1.3);
        }
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1025;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }
        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .action-btn i {
            color: white;
            font-size: 1.2rem;
        }
        .burger-btn {
            background: linear-gradient(135deg, #c28b00, #966d00);
            color: white;
        }
        .image-collage {
            display: grid;
            gap: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }
        .image-collage img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 1;
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            .post-title {
                font-size: 2rem;
            }
            .post-content {
                font-size: 1rem;
            }
            .floating-action-buttons {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>

<body class="bg-body-tertiary">
    <!--
        CRITICAL FIX: The entire header is now a single `fixed-header-container`
        that will stay at the top of the viewport.
    -->
    <div class="fixed-header-container">
        <div class="container mt-3 mb-1">
            <nav class="navbar navbar-expand-lg rounded-3 px-3">
                <a class="navbar-brand d-flex align-items-center flex-wrap" href="/">
                    <img class="navbar-logo me-2 rounded-circle" />
                    <span class="header-title">Temples - The Heart of Sanathana dharma</span>
                </a>
            </nav>
        </div>
    </div>

    <!--
        CRITICAL FIX: This is the main content wrapper. The top margin
        ensures the content starts below the fixed header.
    -->
    <div class="main-content-wrapper container">
        <div class="container my-4">
            <!-- Post Header -->
            <div class="post-header">
                <h1 class="post-title" id="postTitle">Loading...</h1>
                <p class="post-meta" id="postMeta">
                    <span id="postAuthor">Loading...</span> | <span id="postDate">Loading...</span>
                </p>
                <div id="postTags" class="d-flex flex-wrap">
                    <!-- Tags will be dynamically inserted here -->
                </div>
            </div>

            <!-- Image Gallery -->
            <div class="image-gallery" id="imageGallery">
                <div class="loading" id="loadingImages">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p class="mt-2">Loading images...</p>
                </div>
                <!-- Images will be dynamically inserted here -->
            </div>

            <!-- Post Content -->
            <div class="post-content" id="postContent">
                <div class="loading" id="loadingContent">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p class="mt-2">Loading content...</p>
                </div>
                <!-- Content from contents.md will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Floating Navigation Menu -->
    <nav class="floating-nav" id="floatingNav">
        <div class="mb-3">
            <h6 class="text-muted mb-2">Navigation</h6>
            <div id="dynamicNav">
                <!-- Dynamic navigation items will be inserted here -->
            </div>
        </div>
    </nav>
    
    <!-- Floating Action Buttons -->
    <div class="action-buttons">
        <button class="menu-toggle action-btn burger-btn" onclick="toggleFloatingNav()">
            <i class="fas fa-bars"></i>
        </button>
        <button class="btn btn-outline-secondary" id="themeToggle">
            <i class="fas fa-sun me-2"></i><span id="themeText">Light Theme</span>
        </button>
    </div>

    <!-- Bootstrap JS and marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let currentPost = null;
        let postSlug = '';
        let postsData = [];
        
        function showCustomAlert(message, alertType = 'success') {
            const alertBox = document.createElement('div');
            alertBox.className = `alert alert-${alertType} alert-dismissible fade show position-fixed top-0 end-0 mt-5 me-3`;
            alertBox.style.maxWidth = '400px';
            alertBox.style.zIndex = '1100';
            alertBox.role = 'alert';
            alertBox.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                const bootstrapAlert = bootstrap.Alert.getInstance(alertBox);
                if (bootstrapAlert) {
                    bootstrapAlert.close();
                } else {
                    alertBox.remove();
                }
            }, 3000);
            return false;
        }

        function handleTagClick(tag) {
            event.stopPropagation();
            const postsWithTag = postsData.filter(post => post.tags.includes(tag));
            const count = postsWithTag.length;
            const message = `There are ${count} posts with the tag: #${tag}.`;
            showCustomAlert(message);
        }

        function toggleFloatingNav() {
            const nav = document.getElementById('floatingNav');
            const isShown = nav.classList.toggle('show');
            document.body.classList.toggle('no-scroll', isShown);
        }

        function getSlugUrl(slug) {
            return `${basePath}${slug}/`;
        }

        function generateNavigation() {
            const staticPosts = postsData.filter(post => post.type === 'static' && !post.hide);
            const navContainer = document.getElementById('dynamicNav');
            let navHTML = '';
            staticPosts.forEach(post => {
                const icon = post.slug === 'about' ? 'info-circle' : 'universal-access';
                navHTML += `<a class="nav-link" href="${getSlugUrl(post.slug)}"><i class="fas fa-${icon} me-2"></i>${post.title}</a>`;
            });
            navContainer.innerHTML = navHTML;
        }

        function getPostSlugFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/').filter(p => p);
            return parts.length > 0 ? parts[parts.length - 1] : null;
        }

        function displayPostDetails(postData) {
            if (!postData) {
                console.error("Post data is not available.");
                document.getElementById('postTitle').textContent = "Post Not Found";
                document.getElementById('postContent').innerHTML = "<p>The post you are looking for does not exist.</p>";
                return;
            }
            document.getElementById('pageTitle').textContent = postData.title;
            document.getElementById('postTitle').textContent = postData.title;
            document.getElementById('postAuthor').textContent = postData.author;
            document.getElementById('postDate').textContent = new Date(postData.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            const tagsContainer = document.getElementById('postTags');
            tagsContainer.innerHTML = '';
            if (postData.tags && postData.tags.length > 0) {
                postData.tags.forEach(tag => {
                    const tagLink = document.createElement('a');
                    tagLink.textContent = tag;
                    tagLink.className = 'tag-link';
                    tagLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        handleTagClick(tag);
                    });
                    tagsContainer.appendChild(tagLink);
                });
            }
        }

        async function findAndDisplayImages(postData) {
            const gallery = document.getElementById('imageGallery');
            const loadingIndicator = document.getElementById('loadingImages');
            const postImages = [];
            let foundImages = false;
            let imgurl;
            const promises = [];
            for (let i = 1; i <= MAX_IMGS_TO_FETCH; i++) {
                promises.push(fetch(`${basePath}posts/${postSlug}/img${i}.jpg`, { method: 'HEAD', cache: 'no-store' }));
            }
            try {
                const responses = await Promise.all(promises);
                responses.forEach((response, index) => {
                    if (response.ok) {
                        imgurl = `${basePath}posts/${postSlug}/img${index + 1}.jpg`;
                        postImages.push(imgurl);
                        foundImages = true;
                    }
                });
            } catch (error) {
                console.error('Error fetching images:', error);
            }
            if (!postData || !foundImages) {
                if (loadingIndicator) loadingIndicator.remove();
                gallery.innerHTML = `
                    <div class="alert alert-warning text-center" role="alert">
                        No images were found for this post.
                    </div>
                `;
                console.warn(`no img<?>.jpg files found for slug: ${postSlug} .`);
                return;
            }
            if (loadingIndicator) loadingIndicator.remove();
            const imageCount = postImages.length;
            let colClass = 'col-12';
            if (imageCount === 1) {
                colClass = 'col-12';
            } else if (imageCount === 2) {
                colClass = 'col-12 col-md-6';
            } else if (imageCount === 3) {
                colClass = 'col-12 col-md-4';
            } else if (imageCount === 4) {
                colClass = 'col-12 col-sm-6';
            } else if (imageCount === 5) {
                colClass = 'col-12 col-md-4';
            } else if (imageCount >= 6) {
                colClass = 'col-12 col-sm-6 col-md-4 col-lg-3';
            }
            let galleryHTML = '<div class="row g-3">';
            postImages.forEach(imageUrl => {
                galleryHTML += `
                    <div class="${colClass}">
                        <div class="card h-100 overflow-hidden shadow-sm">
                            <img src="${imageUrl}" class="card-img-top h-100 object-fit-cover" alt="Post image" loading="lazy">
                        </div>
                    </div>
                `;
            });
            galleryHTML += '</div>';
            gallery.innerHTML = galleryHTML;
        }

        async function displayContent() {
            const contentContainer = document.getElementById('postContent');
            const loadingIndicator = document.getElementById('loadingContent');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
            try {
                const response = await fetch(`${basePath}posts/${postSlug}/contents.md`);
                if (response.ok) {
                    const markdownText = await response.text();
                    contentContainer.innerHTML = marked.parse(markdownText);
                } else {
                    contentContainer.innerHTML = `
                        <div class="alert alert-warning text-center" role="alert">
                            No content was found for this post.
                        </div>
                    `;
                    console.warn(`contents.md not found for slug: ${postSlug}, using placeholder content.`);
                }
            } catch (e) {
                console.error(`Error fetching contents.md for slug: ${postSlug}`, e);
                contentContainer.innerHTML = `
                    <div class="alert alert-danger text-center" role="alert">
                        An error occurred while loading the post content.
                    </div>
                `;
            }
        }

        function initializeThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const themeText = document.getElementById('themeText');
            if (!themeToggle || !themeText) return;
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme') || 'dark';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            function setTheme(theme) {
                document.documentElement.setAttribute('data-bs-theme', theme);
                if (theme === 'light') {
                    themeText.textContent = 'Dark Theme';
                    themeToggle.querySelector('i').className = 'fas fa-moon me-2';
                } else {
                    themeText.textContent = 'Light Theme';
                    themeToggle.querySelector('i').className = 'fas fa-sun me-2';
                }
            }
        }

        async function initializePage() {
            postSlug = getPostSlugFromUrl();
            if (!postSlug) {
                document.getElementById('postTitle').textContent = "Invalid URL";
                document.getElementById('postContent').innerHTML = "<p>Please navigate to a valid blog post page.</p>";
                document.getElementById('loadingImages').remove();
                document.getElementById('loadingContent').remove();
                initializeThemeToggle();
                return;
            }
            try {
                const postsResponse = await fetch(`${basePath}posts.json`);
                if (!postsResponse.ok) {
                    throw new Error('Failed to fetch central posts.json');
                }
                postsData = await postsResponse.json();
                const post = postsData.find(p => p.slug === postSlug);
                if (post) {
                    currentPost = post;
                    displayPostDetails(currentPost);
                    (async () => {
                        try {
                            await findAndDisplayImages(currentPost);
                        } catch (error) {
                            console.error('Error loading images:', error);
                        }
                    })();
                    generateNavigation();
                    displayContent(currentPost);
                } 
                else {
                    document.getElementById('postTitle').textContent = "Post Not Found";
                    document.getElementById('postContent').innerHTML = "<p>The post you are looking for does not exist. Please check the URL and try again.</p>";
                    document.getElementById('loadingImages').remove();
                    document.getElementById('imageGallery').innerHTML = '';
                    document.getElementById('loadingContent').remove();
                }
            } catch (e) {
                console.error("Error during page initialization:", e);
                document.getElementById('postTitle').textContent = "Error Loading Post";
                document.getElementById('postContent').innerHTML = "<p>There was an error loading the blog post data. Please check the console for details.</p>";
                document.getElementById('loadingImages').remove();
                document.getElementById('loadingContent').remove();
            } finally {
                initializeThemeToggle();
            }
        }
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
